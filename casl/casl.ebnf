# casl/grammar.py
"""
CASL — Cppcheck Addon Specification Language
PEG grammar for Parsimonious
"""

CASL_GRAMMAR = r'''
    program           = _ preamble? _ items _

    preamble          = addon_decl

    addon_decl        = "addon" _ identifier _ string_literal? _ lbrace _
                        addon_body _ rbrace

    addon_body        = addon_field*

    addon_field       = ("cwe" / "severity" / "description" / "version"
                        / "author" / "license") _ "=" _ expr _ semi

    items             = item*
    item              = import_stmt
                      / checker_decl
                      / fn_decl
                      / type_alias
                      / const_decl
                      / stmt

    # ── Imports ──────────────────────────────────────────────────
    import_stmt       = "import" _ import_path _ semi
    import_path       = identifier ("." identifier)*

    # ── Checker ──────────────────────────────────────────────────
    checker_decl      = docstring? _ "checker" _ identifier _ lbrace _
                        checker_body _ rbrace

    checker_body      = checker_member*

    checker_member    = error_id_decl
                      / severity_decl
                      / cwe_decl
                      / confidence_decl
                      / pattern_decl
                      / query_decl
                      / on_block
                      / suppress_decl
                      / fn_decl
                      / let_stmt

    error_id_decl     = "error_id" _ "=" _ string_literal _ semi
    severity_decl     = "severity" _ "=" _ severity_level _ semi
    severity_level    = "error" / "warning" / "style" / "portability"
                      / "performance" / "information"
    cwe_decl          = "cwe" _ "=" _ integer _ semi
    confidence_decl   = "confidence" _ "=" _ ("certain" / "probable"
                      / "possible") _ semi

    # ── Patterns (PQL-inspired) ──────────────────────────────────
    pattern_decl      = docstring? _ "pattern" _ identifier _ lparen _
                        param_list? _ rparen _ lbrace _ pattern_body _
                        rbrace

    pattern_body      = pattern_clause+

    pattern_clause    = match_clause
                      / where_clause
                      / ensures_clause

    match_clause      = "match" _ pattern_expr _ semi
    where_clause      = "where" _ expr _ semi
    ensures_clause    = "ensures" _ expr _ semi

    pattern_expr      = token_pattern
                      / scope_pattern
                      / call_pattern
                      / assign_pattern
                      / deref_pattern
                      / binop_pattern
                      / wildcard_pattern

    token_pattern     = "token" _ lparen _ token_constraints? _ rparen
    token_constraints = token_constraint (_ "," _ token_constraint)*
    token_constraint  = identifier _ "=" _ expr

    scope_pattern     = "scope" _ lparen _ identifier _ rparen
    call_pattern      = "call" _ lparen _ expr _ ("," _ expr)* _ rparen
    assign_pattern    = "assign" _ lparen _ pattern_expr _ "," _
                        pattern_expr _ rparen
    deref_pattern     = "deref" _ lparen _ pattern_expr _ rparen
    binop_pattern     = "binop" _ lparen _ string_literal _ "," _
                        pattern_expr _ "," _ pattern_expr _ rparen
    wildcard_pattern  = "_"

    # ── Queries (dataflow / shims) ───────────────────────────────
    query_decl        = docstring? _ "query" _ identifier _ lparen _
                        param_list? _ rparen _ arrow _ type_expr _
                        lbrace _ stmts _ rbrace

    # ── On blocks (event-driven) ─────────────────────────────────
    on_block          = "on" _ on_event _ lbrace _ stmts _ rbrace

    on_event          = "token" / "scope" / "function" / "variable"
                      / "cfg" / "init" / "finish"

    # ── Functions ────────────────────────────────────────────────
    fn_decl           = docstring? _ "fn" _ identifier _ lparen _
                        param_list? _ rparen _ (arrow _ type_expr)? _
                        lbrace _ stmts _ rbrace

    param_list        = param (_ "," _ param)*
    param             = identifier _ (":" _ type_expr)?

    # ── Types ────────────────────────────────────────────────────
    type_alias        = "type" _ identifier _ "=" _ type_expr _ semi
    type_expr         = type_generic / type_list / type_map / type_set
                      / type_option / type_name
    type_generic      = identifier _ "<" _ type_expr (_ "," _
                        type_expr)* _ ">"
    type_list         = "List" _ "<" _ type_expr _ ">"
    type_map          = "Map" _ "<" _ type_expr _ "," _ type_expr _ ">"
    type_set          = "Set" _ "<" _ type_expr _ ">"
    type_option       = "Option" _ "<" _ type_expr _ ">"
    type_name         = identifier

    # ── Constants ────────────────────────────────────────────────
    const_decl        = "const" _ identifier _ (":" _ type_expr)? _ "="
                        _ expr _ semi

    # ── Suppress ─────────────────────────────────────────────────
    suppress_decl     = "suppress" _ string_literal _
                        (string_literal)? _ semi

    # ── Statements ───────────────────────────────────────────────
    stmts             = stmt*
    stmt              = let_stmt
                      / assign_stmt
                      / if_stmt
                      / for_stmt
                      / while_stmt
                      / return_stmt
                      / emit_stmt
                      / expr_stmt
                      / break_stmt
                      / continue_stmt

    let_stmt          = "let" _ "mut"? _ identifier _ (":" _ type_expr)?
                        _ "=" _ expr _ semi
    assign_stmt       = lvalue _ assign_op _ expr _ semi
    assign_op         = "=" / "+=" / "-=" / "*=" / "/=" / "|=" / "&="
    lvalue            = member_access / index_access / identifier

    if_stmt           = "if" _ expr _ lbrace _ stmts _ rbrace _
                        elif_clause* _ else_clause?
    elif_clause       = "elif" _ expr _ lbrace _ stmts _ rbrace _
    else_clause       = "else" _ lbrace _ stmts _ rbrace

    for_stmt          = "for" _ identifier _ "in" _ expr _ lbrace _
                        stmts _ rbrace
    while_stmt        = "while" _ expr _ lbrace _ stmts _ rbrace
    return_stmt       = "return" _ expr? _ semi
    emit_stmt         = "emit" _ identifier _ lparen _ arg_list? _
                        rparen _ semi
    break_stmt        = "break" _ semi
    continue_stmt     = "continue" _ semi
    expr_stmt         = expr _ semi

    # ── Expressions ──────────────────────────────────────────────
    expr              = match_expr / ternary

    match_expr        = "match" _ expr _ lbrace _ match_arm+ _ rbrace
    match_arm         = pattern_val _ "=>" _ expr _ ","? _
    pattern_val       = string_literal / integer / float_lit / "true"
                      / "false" / "null" / identifier / "_"

    ternary           = logical_or _ ("?" _ expr _ ":" _ expr)?
    logical_or        = logical_and (_ "||" _ logical_and)*
    logical_and       = bitwise_or (_ "&&" _ bitwise_or)*
    bitwise_or        = bitwise_xor (_ "|" _ bitwise_xor)*
    bitwise_xor       = bitwise_and (_ "^" _ bitwise_and)*
    bitwise_and       = equality (_ "&" _ equality)*
    equality          = comparison (_ ("==" / "!=") _ comparison)*
    comparison        = addition (_ ("<=" / ">=" / "<" / ">") _
                        addition)*
    addition          = multiplication (_ ("+" / "-") _ multiplication)*
    multiplication    = unary (_ ("*" / "/" / "%") _ unary)*
    unary             = (("!" / "-" / "~") _ unary) / postfix
    postfix           = primary postfix_op*
    postfix_op        = call_op / index_op / member_op / method_op
    call_op           = lparen _ arg_list? _ rparen
    index_op          = lbracket _ expr _ rbracket
    member_op         = "." identifier
    method_op         = "." identifier _ lparen _ arg_list? _ rparen

    primary           = lambda_expr
                      / list_literal
                      / map_literal
                      / set_literal
                      / string_literal
                      / float_lit
                      / integer
                      / bool_lit
                      / null_lit
                      / identifier
                      / grouped

    lambda_expr       = "|" _ param_list? _ "|" _ (arrow _ type_expr)?
                        _ lbrace _ stmts _ rbrace
    list_literal      = lbracket _ (expr (_ "," _ expr)*)? _ rbracket
    map_literal       = lbrace _ (map_entry (_ "," _ map_entry)*)? _
                        rbrace
    map_entry         = expr _ ":" _ expr
    set_literal       = "set" _ lbrace _ (expr (_ "," _ expr)*)? _
                        rbrace
    grouped           = lparen _ expr _ rparen

    arg_list          = expr (_ "," _ expr)*

    # ── Docstrings ───────────────────────────────────────────────
    docstring         = ~'\"\"\"[^\"]*?\"\"\"'s _

    # ── Terminals ────────────────────────────────────────────────
    string_literal    = ~'"([^"\\\\]|\\\\.)*"' / ~"'([^'\\\\]|\\\\.)*'"
    float_lit         = ~r"\d+\.\d+([eE][+-]?\d+)?"
    integer           = ~r"0[xX][0-9a-fA-F]+" / ~r"0[oO][0-7]+"
                      / ~r"0[bB][01]+" / ~r"\d+"
    bool_lit          = "true" / "false"
    null_lit          = "null"
    identifier        = ~r"[a-zA-Z_][a-zA-Z_0-9]*"

    # ── Punctuation ──────────────────────────────────────────────
    semi              = ";" _
    lbrace            = "{" _
    rbrace            = "}" _
    lparen            = "(" _
    rparen            = ")" _
    lbracket          = "[" _
    rbracket          = "]" _
    arrow             = "->" _

    # ── Whitespace & Comments ────────────────────────────────────
    _                 = spacer*
    spacer            = ~r"\s+" / line_comment / block_comment
    line_comment      = ~r"//[^\r\n]*"
    block_comment     = ~r"/\*[\s\S]*?\*/"
'''
